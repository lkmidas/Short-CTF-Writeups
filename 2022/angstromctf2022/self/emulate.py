from pwn import *

raw_code = bytes.fromhex("000000D8011000D8FF3100D8000001D8001001D8002001D8003001D8004001D8005001D8006001D8007001D8008001D8009001D800A001D800B001D800C001D800D001D800E001D800F001D8FFAF01D854A0016901A00117FF9F01D85090016901900117FF8F01D84C80016901800117FF7F01D8487001690170011774F001D8DDE801D850D901D810C001D801B001D81C0001D604C0016901C001171E100116FD0F006911E001D6001001D610C001D6000001D61C0001D604C0016901C001171E100116FD0F006911E001D6001001D610C001D6000001D61C0001D604C0016901C001171E100116FD0F006911E001D6001001D610C001D6000001D61C0001D604C0016901C001171B100116FD0F006911B001D6001001D610C001D6000001D61C0001D604C0016901C001171B100116FD0F006911B001D6001001D610C001D6000001D61C0001D604C0016901C001171B100116FD0F006911B001D6001001D610C001D6000001D60AF0016901F001171BE0011701D001171E0086161D008616000000181E0086171D008617009085A600C081A6009081A6006081A6003081A6FFFFFFFFBF627C9CBAAD766E17EE004D6831FC6101E3D597614D2C47110EA40905714314A9CC0AD31A74B1E508F6D6FFAC4D6F94AD63980FAFF35E4BA18538C469FE6B8956DB3BFCDB6AFBCEEBBB9E585E820C7F82E9762AF3CAF3ADFA1EBEA4A4888B592A72B64DBE0F980F6B0E75B875710CDE5388855DF133EEB4E61A753D0266D34D910B3AE55182D78784F823A03EB9E6542F924887FED312E83B8594DCE40727B5F7C99C381BA1165E77F8BA44AC3E18FC21928A4B47B103855542C7B7CA52222BCFD93DC0668361EDCE8F5E20B261A5E3A078BB506981F88BB8C342182A2C5EE8462726856AD17BB98517882F8AC0BC8364860A25A537CF8DDAB613CAE0C4661B5D6615433EA587C9D77FA3AF7361D62A098E2D0DFAAAD7F062C755DCE0128F0DF6834BC19539199BBDA10ABFE215FFB2356DEDA084A7C50340A6D9C0E6A26457673ACC5B218292643F1AF5929A2600777AA5FFCF00B78DF89509E5845E44DF1FAFAB0CCE31026281DE6C6BEBEE5C6334DD63E4D72AC8FB30D01742936AEE1A17760A2EA8520599CB779C4E30D23AB5F3FB58A72BB4359A0B72F676A0F96C6E2FC0E47D66C18C875A5925EA194D0D8ABC96075B99C94D8E443033B987AAA8E3C340C7B923D1790F0A0BB92842BF627C44BBBD76B6E8DF00956831FDB901F3D44F616D2D9F113EA5D1053142CCA99C0B0B1A14B03D0886D727ACCD6E4CADF399D7AF535F93A135391C693E6A51560B3A24DB8AFA16EB4B9F80547213A7FFE956F294DAD375943E9E7CCBB8AB8146329695DF5FB8D7346E556019012C063F08A58590A3CE6CB9BA55E577D6F395FECB1A3D2852F75FDB1803784D49C68C4E92695F89C3333064A5B5048337066D9689BDE077F1378611989B9CF34E39244412AB932F21225D21E2E66FB1E203F3A9191C1812534035AD6F7FF8D391843B8388BA886861F953A81343C0372C5F3E42F727EC6B017AAE9A07893977CFBCEA75760BF3A527CE5BCA66121CE0C467CD406614953A7586A0D6AFA2B86C71D73CF4812D64EB5AD62662D7540AF0C28EDBF6834A178839184DB9710BD6E3C5FEA52A7DECB679A8C56A5156D816E6B2658177EACD8D218293B2221AF4449EF6011E7B75FED81EA78CEE6806E5ED4FA4DEC9AFBB0D1821D26357DE6C6A3DF35C62E2D9B3E5BE2B18FA27CE07438597E11A7E67EA2F7E5215981D674C4FE6D23AB425E658A6FDB0E59B62732677B7E77C6F393DEB7D0FD06C868C5935EBCF5DDD8B6A96075A4FCFBD8F2D2FB33491AA68FC355F473434CF890E1D0BE9A5E4")
code = []
for i in range(0, len(raw_code), 4):
    code += [int.from_bytes(raw_code[i:i+4], "little")]
mem = [0] * 0x800 + code + [0] * 0x800

pc = 0x800
inst = mem[pc]

# Patching out the infinite loops
mem[0x813] = 0xd801a001
mem[0x816] = 0xd8019001
mem[0x819] = 0xd8018001
mem[0x81c] = 0xd8017001

while inst:

    op = (inst >> 24) & 0xff
    r1 = inst & 0xfff
    r2 = (inst >> 12) & 0xfff

    pp = 0 # 1

    if pp:
        print("{:03x}: inst = {:08x}: ".format(pc, inst), end="")

    if op == 0xd6:
        mem[r2] = mem[r1]
        if pp:
            print("MOV mem[{:03x}] -> mem[{:03x}]".format(r1, r2))
    elif op == 0xd8:
        mem[r2] = (mem[r2] & 0xff000000) | r1
        if pp:
            print("MOV {:03x} -> mem[{:03x}]".format(r1, r2))
    elif op == 0xf6:
        print(chr(mem[r2] & 0xffffff), end="")
        if pp:
            print("PUTC mem[{:03x}]".format(r2))
    elif op == 0xf7:
        mem[r2] = (mem[r2] & 0xff000000) | (ord(input()[0]) & 0xff)
        if pp:
            print("GETC mem[{:03x}]".format(r2))
    elif op == 0x18:
        mem[r2] ^= mem[r1]
        if pp:
            print("XOR mem[{:03x}] ^ mem[{:03x}] -> mem[{:03x}]".format(r2, r1, r2))
    elif op == 0x16:
        tmp1 = mem[r2]
        tmp2 = (mem[r1] + tmp1) & 0xffffff
        mem[r2] = tmp1 & 0xff000000
        mem[r2] += tmp2
        if pp:
            print("ADD mem[{:03x}] + mem[{:03x}] -> mem[{:03x}]".format(r2, r1, r2))
    elif op == 0x17:
        tmp1 = mem[r2]
        tmp2 = (tmp1 - mem[r1]) & 0xffffff
        mem[r2] = tmp1 & 0xff000000
        mem[r2] += tmp2
        if pp:
            print("SUB mem[{:03x}] - mem[{:03x}] -> mem[{:03x}]".format(r2, r1, r2))
    elif op == 0x69:
        x = 1
        if mem[r2] == 0:
            x = r1
        pc = (pc + x - 1) & 0xfff
        if pp:
            print("JZ mem[{:03x}] == 0 -> pc = pc + {:03x}".format(r2, r1))
    elif op == 0xa6:
        pc = r2
        if pp:
            print("JMP pc = {:03x}".format(r2+1))
    elif op == 0xff:
        if pp:
            print("NOP")
    else:
        print("UNKNOWN")
        break

    pc += 1
    inst = mem[pc]
    
